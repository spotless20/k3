#############################################################################################################
# BASE SETUP
#############################################################################################################

[include mainsail.cfg]
[include timelapse.cfg]
[include printerfiles/caselight.cfg]
[include printerfiles/commands.cfg]
[include printerfiles/fans.cfg]
[include printerfiles/heater.cfg]
[include printerfiles/makros.cfg]


#############################################################################################################
# STEPPER MOTORS, DRIVERS 
#############################################################################################################

[include printerfiles/autotune.cfg]
[include printerfiles/motion_xy.cfg]
[include printerfiles/motion_z.cfg]
[include printerfiles/tool.cfg]


#############################################################################################################
#   ADXL
#############################################################################################################

#[include printerfiles/adxl.cfg]
#[include K-ShakeTune/*.cfg]

#############################################################################################################
# Printer Config
#############################################################################################################

[printer]
kinematics: cartesian
max_velocity: 800
max_accel: 10000
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 8.0

#############################################################################################################
# MCUs
#############################################################################################################

[mcu] 
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_16001F001151313236343430-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_24823969515137474C202020FF0D2342-if00
#serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_3A82FBB74E4B333448202020FF0A3211-if00
x_offset: -21.5
y_offset: 0
mesh_main_direction: x 
mesh_runs: 2

[temperature_sensor octo]
sensor_type: temperature_mcu


#############################################################################################################
# Probing
#############################################################################################################

[homing_override]
axes: xyz
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}
  
  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}
  
  {% if home_all or 'Z' in params %}
    SET_KINEMATIC_POSITION Z=10
    G90
    G1 X90 Y90 F15000
    G28 Z
    G1 Z10
  {% endif %}

[z_tilt]
z_positions: 
    -74.0, -18.0    # Front Left
    76.0,  217.0    # Rear
    226.0, -18.0    # Front Right
points:
    43.5, 25          # Front Left
    99.5, 130        # Rear
    173.5, 25         # Front Right
speed: 300
horizontal_move_z: 15.0
retries: 4
retry_tolerance: 0.006

[gcode_macro Z_TILT_ADJUST]
rename_existing: _Z_TILT_ADJUST
gcode:
    _z_tilt_adjust RETRY_TOLERANCE=1
    _z_tilt_adjust HORIZONTAL_MOVE_Z=2
    G28 Z

[bed_mesh]
mesh_min: 20,20
mesh_max: 158,150
algorithm: bicubic
horizontal_move_z: 3
probe_count: 14,14
speed: 250
mesh_pps: 0,0


#############################################################################################################
#   InputShaper
#############################################################################################################

[input_shaper]
smoother_freq_x: 95.8
shaper_type_x: smooth_ei

smoother_freq_y: 90.4
shaper_type_y: smooth_ei
enabled_extruders: extruder

#############################################################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 22.465
#*# pid_ki = 1.249
#*# pid_kd = 101.045
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 42.381
#*# pid_ki = 1.228
#*# pid_kd = 365.535
#*#
#*# [beacon model default]
#*# model_coef = 1.6320188430604232,
#*# 	1.77869127606186,
#*# 	0.7507554148570488,
#*# 	0.525423133254053,
#*# 	0.2129205869362673,
#*# 	-0.43024860898936107,
#*# 	0.13024952952455168,
#*# 	0.5614864047050887,
#*# 	-0.13157395022785678,
#*# 	-0.027149184203688895
#*# model_domain = 3.231537149417749e-07,3.344098204560401e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 32.477494
#*# model_offset = 0.02500
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.011319, 0.004714, -0.002387, -0.003817, -0.000822, 0.002935, 0.006459, 0.003606, 0.003283, 0.005144, 0.006635, 0.006080, 0.006294, 0.007341
#*# 	  0.009955, 0.006201, -0.000386, -0.003886, -0.003346, -0.003109, 0.002275, -0.003170, 0.002018, 0.007223, 0.011048, 0.010253, 0.008000, 0.007543
#*# 	  -0.003779, -0.009041, -0.014225, -0.016393, -0.017328, -0.019517, -0.016500, -0.013871, -0.005780, 0.001868, 0.005193, 0.005226, 0.002264, -0.001492
#*# 	  -0.012941, -0.028909, -0.030417, -0.028751, -0.027717, -0.028102, -0.025282, -0.019398, -0.009867, -0.004709, 0.001914, 0.001265, 0.000407, -0.001425
#*# 	  -0.020074, -0.035910, -0.038106, -0.032262, -0.029028, -0.030649, -0.028103, -0.019638, -0.008896, 0.002996, 0.005315, 0.005082, 0.003758, 0.010441
#*# 	  -0.018360, -0.034009, -0.036917, -0.032735, -0.028439, -0.027608, -0.025579, -0.015950, -0.002893, 0.007819, 0.012938, 0.011469, 0.009242, 0.012275
#*# 	  -0.015604, -0.026793, -0.029826, -0.027684, -0.021777, -0.018407, -0.014250, -0.002786, 0.008562, 0.017248, 0.021789, 0.020081, 0.020100, 0.026483
#*# 	  -0.000427, -0.009296, -0.011891, -0.006309, 0.000946, 0.002792, 0.010762, 0.017891, 0.030445, 0.036974, 0.038927, 0.042230, 0.045645, 0.051332
#*# 	  0.010488, 0.005002, 0.002627, 0.009609, 0.018807, 0.024178, 0.033099, 0.036855, 0.046426, 0.051645, 0.053211, 0.056648, 0.062199, 0.068656
#*# 	  0.007564, -0.000578, -0.001573, 0.001209, 0.012429, 0.018568, 0.027421, 0.031483, 0.041780, 0.047307, 0.051537, 0.057582, 0.062326, 0.067038
#*# 	  -0.009920, -0.017516, -0.015449, -0.010187, 0.000523, 0.000681, 0.012461, 0.018368, 0.029464, 0.038747, 0.050127, 0.053380, 0.057599, 0.063053
#*# 	  0.000113, -0.008837, -0.009988, -0.003442, 0.001218, 0.008658, 0.016740, 0.023834, 0.038523, 0.052226, 0.063824, 0.066841, 0.073229, 0.076839
#*# 	  0.012393, 0.008364, 0.006107, 0.011989, 0.020322, 0.028149, 0.034933, 0.041135, 0.057613, 0.073952, 0.082684, 0.086780, 0.089596, 0.097958
#*# 	  0.031321, 0.028372, 0.028717, 0.033246, 0.044209, 0.049701, 0.056529, 0.062779, 0.078418, 0.095580, 0.106944, 0.109735, 0.111293, 0.114417
#*# x_count = 14
#*# y_count = 14
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = direct
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 158.0
#*# min_y = 20.0
#*# max_y = 150.0
